{% extends "base.html" %}


{% block content %}

<link href="/stylesheets/entries.css" rel="stylesheet">

<span data-bind="visible: loaded() == false">Loading...</span>

<table data-bind="visible: loaded()" class="data_table" style="display:none">

    <thead>
    <tr>
        <th>ID</th>
        <th>Date</th>
        <th>Bank Note</th>
        <th>Note</th>
        <th>Tag</th>
        <th>Where</th>
        <th>What</th>
        <th>Amount</th>
        <th>&nbsp;</th>
    </tr>
    </thead>

    <tbody data-bind="foreach: entries">
    <tr data-bind="groupFocus: editing">
        <td class="width-1"><span data-bind="text: id"></span></td>
        <td class="width-3">
            <b data-bind="text: date, visible: !editing()"></b>
            <input data-bind="value: date, visible: editing, css: {error: validation('date')}" title="Date"
                   class="width-3"/>
            <span data-bind="text: validation('date'), visible: validation('date')" class="error_message"></span>
        </td>
        <td class="width-6">
            <b data-bind="text: bank_note, visible: !editing()"></b>
            <input data-bind="value: bank_note, visible: editing, css: {error: validation('bank_note')}"
                   title="Bank Note" class="width-6"/>
            <span data-bind="text: validation('bank_note'), visible: validation('bank_note')"
                  class="error_message"></span>
        </td>
        <td class="width-6">
            <b data-bind="text: note, visible: !editing()"></b>
            <input data-bind="value: note, visible: editing, css: {error: validation('note')}" title="Note"
                   class="width-6"/>
            <span data-bind="text: validation('note'), visible: validation('note')" class="error_message"></span>
        </td>
        <td class="tag width-3" data-bind="style: {color: tagColor(), backgroundColor: tagBGColor()}">
            <b data-bind="text: tag, visible: !editing()"></b>
            <select data-bind="value: tag, foreach: $root.entryTags, visible: editing, css: {error: validation('tag')}"
                    title="Tag" class="width-3">
                <option data-bind="value: tag, text: tag"></option>
            </select>
            <span data-bind="text: validation('tag'), visible: validation('tag')" class="error_message"></span>
        </td>
        <td class="width-6">
            <b data-bind="text: where, visible: !editing()"></b>
            <input data-bind="value: where, visible: editing, css: {error: validation('where')}" title="Where"
                   class="width-6"/>
            <span data-bind="text: validation('where'), visible: validation('where')" class="error_message"></span>
        </td>
        <td class="width-6">
            <b data-bind="text: what, visible: !editing()"></b>
            <input data-bind="value: what, visible: editing, css: {error: validation('what')}" title="What"
                   class="width-6"/>
            <span data-bind="text: validation('what'), visible: validation('what')" class="error_message"></span>
        </td>
        <td class="width-2">
            <span data-bind="visible: !editing(), style: { color: amount() > 0 ? 'black' : 'red' }"
                  style="font-weight: bold">
                <span style="float:left ">$</span>
                <span style="float:right" data-bind="text: amount"></span>
            </span>
            <input data-bind="value: amount, visible: editing, css: {error: validation('amount')}" title="Amount"
                   class="width-2"/>
            <span data-bind="text: validation('amount'), visible: validation('amount')" class="error_message"></span>
        </td>
        <td class="width-3">
            <a data-bind="click: del, visible: deleting() == false">Delete</a>
            <a data-bind="click: delReally, visible: deleting() == true">Confirm</a>
            <a data-bind="click: cancelDel, visible: deleting() == true">Cancel</a>
        </td>
    </tr>
    </tbody>

    <tfoot>
    <tr data-bind="with: newEntry">
        <td>&nbsp;</td>
        <td class="width-3">
            <input data-bind="value: date, css: {error: validation('date')}" title="Date" class="width-3"/>
            <span data-bind="text: validation('date'), visible: validation('date')" class="error_message"></span>
        </td>
        <td class="width-6">
            <input data-bind="value: bank_note, css: {error: validation('bank_note')}" title="Bank Note"
                   class="width-6"/>
            <span data-bind="text: validation('bank_note'), visible: validation('bank_note')"
                  class="error_message"></span>
        </td>
        <td class="width-6">
            <input data-bind="value: note, css: {error: validation('note')}" title="Note" class="width-6"/>
            <span data-bind="text: validation('note'), visible: validation('note')" class="error_message"></span>
        </td>
        <td class="width-3" data-bind="style: {color: tagColor(), backgroundColor: tagBGColor()}">
            <select data-bind="value: tag, foreach: $root.entryTags, css: {error: validation('tag')}" title="Tag"
                    class="width-3">
                <option data-bind="value: tag, text: tag"></option>
            </select>
            <span data-bind="text: validation('tag'), visible: validation('tag')" class="error_message"></span>
        </td>
        <td class="width-3">
            <input data-bind="value: where, css: {error: validation('where')}" title="Where" class="width-6"/>
            <span data-bind="text: validation('where'), visible: validation('where')" class="error_message"></span>
        </td>
        <td class="width-3">
            <input data-bind="value: what, css: {error: validation('what')}" title="What" class="width-6"/>
            <span data-bind="text: validation('what'), visible: validation('what')" class="error_message"></span>
        </td>
        <td class="width-2">
            <input data-bind="value: amount, css: {error: validation('amount')}" title="Amount" class="width-2"/>
            <span data-bind="text: validation('amount'), visible: validation('amount')" class="error_message"></span>
        </td>
        <td class="width-3">
            <button data-bind="click: add">Add Entry</button>
        </td>
        <td>&nbsp;</td>
    </tr>
    </tfoot>
</table>

{% endblock %}


{% block scripts %}
<script type='text/javascript' src='/js/objects/account.js'></script>
<script type='text/javascript' src='/js/objects/entry.js'></script>
<script type="text/javascript">

    var account_id = {{account_id}};

    const ViewModel = function () {
        var self = this;

        // Flags
        this.loadedEntries   = ko.observable(false);
        this.loadedEntryTags = ko.observable(false);
        this.loadedAccount   = ko.observable(false);
        this.loaded          = ko.computed(function () {
            return self.loadedEntries() && self.loadedEntryTags() && self.loadedAccount();
        });

        // Storage
        this.entries   = ko.observableArray([]);
        this.entryTags = [];
        this.account   = ko.observable(null);

        // Object under creation
        self.newEntry      = ko.observable(null);
        this.blankNewEntry = function () {
            self.newEntry(new Entry({
                id:         null,
                account_id: account_id,
                amount:     0,
                date:       "1970-01-01",
                bank_note:  "Created via UI",
                note:       "",
                tag:        "",
                what:       "",
                where:      ""
            }, [], this));
        };
    };

    $(document).ready(function () {
        // Configure view model
        viewModel = new ViewModel();
        ko.applyBindings(viewModel);

        // Set up promise chain
        Promise.resolve()

            // Load entry tags
            .then(function () {
                return $.ajax({
                    url:     "/rest/entry/tags",
                    success: function (data) {
                        for (var d of data.data) {
                            viewModel.entryTags.push({tag: d});
                        }
                        viewModel.loadedEntryTags(true);viewModel.blankNewEntry();
                    },
                    error:   function (err) {
                        alert("Cannot load entries. See console for details");
                        console.log("Received HTTP 500. Server said: " + err.responseText)
                    }
                }).promise();
            })

            // Load entries
            .then(function () {
                return $.ajax({
                    url:     "/rest/account/{{account_id}}/entries",
                    success: function (data) {
                        for (var d of data.data) {
                            viewModel.entries.push(new Entry(d, [], viewModel));
                        }
                        viewModel.loadedEntries(true);
                    },
                    error:   function (err) {
                        alert("Cannot load accounts. See console for details");
                        console.log("Received HTTP 500. Server said: " + err.responseText)
                    }
                }).promise();
            })

            // Load entries
            .then(function () {
                return $.ajax({
                    url:     "/rest/account/{{account_id}}",
                    success: function (data) {
                        viewModel.account(new Account(data, viewModel));
                        viewModel.loadedAccount(true);
                    },
                    error:   function (err) {
                        alert("Cannot load accounts. See console for details");
                        console.log("Received HTTP 500. Server said: " + err.responseText)
                    }
                }).promise();
            });
    });


</script>
{% endblock %}
