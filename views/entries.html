{% extends "base.html" %}


{% block content %}

<div id="div_acct_info" style="display:none"></div>

<link href="/stylesheets/entries.css" rel="stylesheet">

<div id="div_loading" class="loading_message">Loading...</div>

<table class="data_table">

    <thead>
    <tr>
        <th class="width-1">ID</th>
        <th class="width-3">Date</th>
        <th class="width-3">Bank Note</th>
        <th class="width-3">Note</th>
        <th class="width-3">Tag</th>
        <th class="width-3">Where</th>
        <th class="width-3">What</th>
        <th class="width-3">Amount</th>
        <th class="width-3">&nbsp;</th>
    </tr>
    </thead>

    <tbody id="tbody_entries" style="display:none"></tbody>

</table>

{% endblock %}


{% block scripts %}
<script type='text/javascript' src='/js/objects/account.js'></script>
<script type='text/javascript' src='/js/objects/entry.js'></script>
<script type="text/javascript">

    var account_id = {{account_id}};

    class ViewModel {
        constructor() {
            var self = this;

            // Flags
            this.loadedEntries   = false;
            this.loadedEntryTags = false;
            this.loadedAccount   = false;

            // Storage
            this.entries   = [];
            this.entryTags = [];
            this.account   = null;
            this.newEntry      = null;
        };

        loaded() { return this.loadedEntries && this.loadedEntryTags && this.loadedAccount; };

        blankNewEntry () {
            this.newEntry = new Entry({
                id:         null,
                account_id: account_id,
                amount:     0,
                date:       "1970-01-01",
                bank_note:  "Created via UI",
                note:       "",
                tag:        "",
                what:       "",
                where:      ""
            }, [], this);
        };

        expressAccount () {
            var div = $("#div_acct_info");
            div.empty();
            div.append(this.account.expressAsPanel());
            div.show();
        }

        expressEntries () {
            var tbody = $("#tbody_entries");
            tbody.empty();
            for (var entry of this.entries)
                tbody.append(entry.expressAsEditableTableRow());
            tbody.show();
        }

        hideLoadingDialog() {
            $("#div_loading").hide();
        }
    }

    $(document).ready(function () {
        // Configure view model
        var viewModel = new ViewModel();

        // Set up promise chain
        Promise.resolve()

            // Load account
            .then(() => {
                return $.ajax({
                    url:     "/rest/account/{{account_id}}",
                    success: function (response) {
                        viewModel.account = new Account(response.data, viewModel);
                        viewModel.loadedAccount = true;
                        viewModel.expressAccount();
                    },
                    error:   function (err) {
                        alert("Cannot load accounts. See console for details");
                        console.log("Received HTTP 500. Server said: " + err.responseText)
                    }
                }).promise();
            })

            // Load entry tags
            .then(() => {
                return $.ajax({
                    url:     "/rest/entry/tags",
                    success: function (response) {
                        for (var d of response.data) {
                            viewModel.entryTags.push(d);
                        }
                        viewModel.loadedEntryTags = true;
                        viewModel.blankNewEntry();
                    },
                    error:   function (err) {
                        alert("Cannot load entries. See console for details");
                        console.log("Received HTTP 500. Server said: " + err.responseText)
                    }
                }).promise();
            })

            // Load entries
            .then(() => {
                return $.ajax({
                    url:     "/rest/account/{{account_id}}/entries",
                    success: function (data) {
                        for (var d of data.data) {
                            viewModel.entries.push(new Entry(d, [], viewModel));
                        }
                        viewModel.loadedEntries = true;
                    },
                    error:   function (err) {
                        alert("Cannot load accounts. See console for details");
                        console.log("Received HTTP 500. Server said: " + err.responseText)
                    }
                }).promise();
            })

            // Load accountings
            .then (() => {
                viewModel.expressEntries();
                viewModel.hideLoadingDialog();
            });
    });

</script>
{% endblock %}
